우아한형제들은 3천만 이상이 사용하는 배달앱 ‘배달의 민족’으로 음식 문화를 선도하고 있음

우아한형제들은 문 앞으로 배달되는 일상의 행복을 비전으로 삼고 있음

배달을 혁신하는 우아한형제들은 배달 로봇 ‘딜리’를 만들며 새로운 인프라를 만들고 있음

우아한형제들은 Delivery Hero와 함께 ‘우아 DH 아시아’를 설립하고 아시아 사업을 총괄하고 있음

배달의 민족 서비스에서 발생하는 대부분의 트래픽은 Amazon Aurora MySQL compatibility에서 처리하고 있음

## Amazon Aurora

Amazon Aurora는 MySQL 및 PostgreSQL 과 호환되는 완전 관리형 관계형 데이터베이스 엔진

- 속도와 안정성 뿐 아니라 비용 효율적이고 단순한 운영의 장점을 가지고 있음
    - MySQL처리량의 최대 5배, PostgreSQL 처리량의 최대 3배 제공
- Aurora 엔진은 고성능 분산 스토리지를 활용해 AZ 3군데에 각 2개씩 총 6개의 데이터를 스토리지 공간에 저장하고 있음
    - 운영 오버헤드의 큰 축인 데이터베이스 클러스터링 및 복제를 자동화하고 표준화함
    
    ![image.png](attachment:6cf74705-fda5-428e-8794-3c4ab4233fde:image.png)
    

### 모니터링의 필요성

- Amazon Aurora 는 완전 관리형 데이터베이스 서비스이지만 보다 안정적인 서비스를 제공하기 위해서는 모니터링을 적절하게 구성하는 것이 중요
- 배달의 민족과 같은 대규모 서비스의 경우 장애 발생을 미리 감지하고 빠르게 장애조치 할 수 있도록 데이터베이스 모니터링을 구성하는 것이 더욱 중요

### 데이터베이스 모니터링의 3대 요소

![image.png](attachment:030c80fd-e847-499c-9b55-21ea89bda5c3:image.png)

모니터링은 ‘로그’ , ‘알람’, ‘메트릭 대시보드’ 3가지로 구분할 수 있음

- 로그는 설정 및 수집, 파싱, 분석 단계를 거쳐 유의미한 모니터링 자료로 사용됨
- 알람은 시스템의 이상 시 각 담당자에게 즉각 알림으로 이상 상황을 빠르게 인지
- 메트릭 대시보드는 장애 발생 시 정확한 원인 파악에 사용되며 상시 확인을 통해 장애 발생의 가능성을 확인할 수 있음

### Cloudwatch 메트릭을 통한 알람 구성

각 Aurora 인스턴스들마다 Cloudwatch 메트릭이 제공됨

배달의 민족에서는 메트릭들 중 임계치가 초과했을 때 Aurora의 이상이 있다고 판단하고 조치를 취하기 위해 알람을 구성하고 있음

![image.png](attachment:a51b68b5-a68f-4077-9e76-94abcb0d0b5a:image.png)

- 워닝 채널과 크리티컬 채널을 별도로 나눠서 알람을 구성
- 워닝채널은 장애까지는 아니지만 1차로 배달의 민족의 데이터베이스 엔지니어가 대응을 하고 개발 팀과 추가로 확인이 필요한 경우 개발 팀에게 내용을 전달하는 용도
- 크리티컬은 장애 위험이 있는 수치로 개발팀과 함께 알람 대응
- 배민에서는 워닝과 크리티컬의 각 항목별 임계치를 다음과 같이 설정해서 사용하고 있음
    - 커넥션의 경우에는 인스턴스의 스펙에 따라 상이하여 스펙별로 별도로 설정하고 있음
- 

| **모니터링 대상** | **워닝 (Warning)** | **크리티컬 (Critical)** |
| --- | --- | --- |
| **CPU Utilization** | 50% 이상 | 70% 이상 |
| **DML Latency** | 200ms 이상 | 500ms 이상 |
| **Select Latency** | 200ms 이상 | 500ms 이상 |
| **Commit Latency** | 20ms 이상 | 50ms 이상 |
| **Buffer Cache hit Ratio** | 90% 이하 |  |
| **Blocked Transaction** | 초당 0.01 개 이상 |  |
| **Rollback Segment History Length** | 30000개 이상 | 70000개 이상 |
- Aurora 에서의 Commit Latency 는 데이터 변경 사항을 Aurora 의 분산 스토리지에 Write 하는데 소요되는 시간
- 이 수치가 증가한다면 대량의 Long Query 또는 높은 트래픽으로 인한 지연 등의 현상이 발생하고 있을 수 있음
    - Rollback Segment history length 는 오래 실행중인 쿼리의 여부를 확인할 수 있습니다.
- MySQL에서 제공되는 Slowquery log는 쿼리가 완료되어야만 로그가 남는것에 비해 Rollback Segment 는 쿼리가 실행중임에도 확인을 할 수 있음
    - Rollback Segment 모니터링을 통해 SlowQuery