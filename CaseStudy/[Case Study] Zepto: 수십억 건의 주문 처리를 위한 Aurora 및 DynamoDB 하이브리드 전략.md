# [Case Study] Zepto: 수십억 건의 주문 처리를 위한 Aurora 및 DynamoDB 하이브리드 전략

## 1. 배경 및 기존 아키텍처

Zepto는 2021년 단 하나의 마이크로 창고로 시작하여 현재 1,000개 이상의 매장을 운영하며 일일 수백만 건의 주문을 처리하는 글로벌 수준의 서비스로 성장했습니다.

* **초기 모델:** 단일 **Amazon Aurora PostgreSQL** 데이터베이스를 사용하는 모놀리식 구조.
* **기존 구성:** 주문 관리(OMS), 재고, 결제 데이터가 하나의 Aurora DB에 집중되어 있었으며, 데이터 레이크는 S3 및 MSK를 통해 동기화되는 방식이었습니다.

---

## 2. 기존 아키텍처의 한계와 도전과제

서비스 규모가 확장됨에 따라 OMS의 `Customer_Orders` 테이블에 수십억 건의 레코드가 쌓이며 운영상의 임계점에 도달했습니다.

* **성능 저하:** 결제 실패 등 특정 주문을 찾기 위해 거대한 테이블을 스캔하면서 읽기 비용이 급증하고, 레코드 잠금 경합으로 인해 쓰기 지연이 발생했습니다.
* **Autovacuum 문제:** 데이터 수정 속도가 너무 빨라 Autovacuum이 실행 계획을 최신화하지 못하거나, 피크 시간에 리소스를 과도하게 점유하는 현상이 발생했습니다.
* **운영 복잡성:** 대규모 인덱스 생성 및 파라미터 튜닝을 위해 오프 피크(Off-peak) 시간대에만 작업을 수행해야 하는 제약이 생겼습니다.

---

## 3. 새로운 데이터 아키텍처: 하이브리드 접근법

Zepto는 모든 데이터를 관계형 DB에 넣는 대신, 확장성이 중요한 영역을 **Amazon DynamoDB**로 이전하는 하이브리드 전략을 채택했습니다.

### 3.1 Draft-Order 서비스 도입

주문이 생성되어 결제가 완료되기 전까지의 '미확정 상태'를 처리하는 경량 마이크로서비스를 별도로 구축했습니다.

1. **주문 수신:** 새 주문이 들어오면 DynamoDB에 Draft 상태로 저장합니다.
2. **상태 업데이트:** 결제 서비스 이벤트를 모니터링하여 DynamoDB의 주문 상태를 갱신합니다.
3. **최종 이행:** 결제가 최종 완료된 건에 대해서만 **Aurora PostgreSQL(OMS)**로 데이터를 전달하여 후속 프로세스를 시작합니다.

---

## 4. DynamoDB 스키마 설계 및 최적화

단일 자릿수 밀리초(Single-digit ms) 지연 시간을 보장하기 위해 다음과 같은 최적화 기법을 적용했습니다.

* **데이터 압축:** 수십 KB에 달하는 주문 스냅샷 데이터를 **Snappy 압축** 기법을 통해 이진(Binary) 타입으로 저장하여 스토리지 비용을 절감하고 성능을 높였습니다.
* **자동 삭제(TTL):** `EXPIRE_AT` 속성을 활용해 며칠이 지난 임시 데이터는 DynamoDB가 자동으로 삭제하도록 설정하여 테이블 크기를 일정하게 유지했습니다.
* **GSI 및 Hot Partition 방지:** 결제 대기 중인 주문 조회를 위해 **Global Secondary Index(GSI)**를 활용하되, 결제 완료 후 인덱스 키 값을 제거(Nullify)하여 인덱스 크기를 관리했습니다.

---

## 5. 프로덕션 배포 및 교훈

* **단계적 트래픽 전환:** 데이터 마이그레이션 없이 신규 주문의 10%부터 시작하여 단계적으로 100%까지 확대 배포했습니다.
* **API 최적화:** 초기에는 `TransactWriteItems`를 사용했으나 평균 18ms의 지연 시간이 발생했습니다. 강력한 일관성이 필요하지 않은 부분을 개별 `PutItem`으로 분리하여 **지연 시간을 10ms 미만으로 단축**하고 비용을 50% 절감했습니다.

---

## 6. 도입 결과 및 혜택

| 항목 | 성과 내용 |
| --- | --- |
| **성능 향상** | 주문 생성 API 성능 평균 **60% 개선**, P99 기준 **40% 개선** |
| **운영 효율** | 패칭, 업그레이드, 파라미터 튜닝 등 인프라 관리 부담(Undifferentiated heavy lifting) 제거 |
| **무한 확장성** | 트래픽 급증 시에도 서버 관리 없이 DynamoDB의 **Auto-scaling**으로 대응 가능 |

---

## 결론

Zepto의 사례는 관계형 DB의 복잡성과 NoSQL의 확장성을 적재적소에 배치한 성공적인 아키텍처 현대화 사례입니다. 특히 모든 데이터를 옮기는 것이 아니라, 가장 부하가 큰 '주문 생성 및 결제 대기' 구간을 분리함으로써 시스템 전체의 안정성을 확보했다는 점이 핵심입니다.